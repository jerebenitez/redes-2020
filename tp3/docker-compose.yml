version: '2.1'

services:
  r1:
    build: .
    volumes:
      - ./volumes/quagga/r1/zebra.conf:/etc/quagga/zebra.conf:ro
      - ./volumes/quagga/r1/ospfd.conf:/etc/quagga/ospfd.conf:ro
      - ./volumes/quagga/r1/ospf6d.conf:/etc/quagga/ospf6d.conf:ro
      - ./volumes/quagga/r1/bgpd.conf:/etc/quagga/bgpd.conf:ro
      - ./volumes/supervisord.conf:/etc/supervisord.conf:ro
    image: ospf:20190321
    privileged: true
    ports:
      #admin
      - 10011:2601
      #ospf
      - 10012:2604
      #ospf ipv6
      - 10013:2606
    networks:
      n101s1:
        ipv4_address: 192.168.1.11 # Conecta R2
      n101s5:
        ipv4_address: 192.168.5.11 # Conecta R3
      common1:
        ipv4_address: 192.168.8.11 # Conecta R4
      common3:
        ipv4_address: 192.168.10.11 # Conecta R5
  r2:
    build: .
    volumes:
      - ./volumes/quagga/r2/zebra.conf:/etc/quagga/zebra.conf:ro
      - ./volumes/quagga/r2/ospfd.conf:/etc/quagga/ospfd.conf:ro
      - ./volumes/quagga/r2/ospf6d.conf:/etc/quagga/ospf6d.conf:ro
      - ./volumes/supervisord.conf:/etc/supervisord.conf:ro
    image: ospf:20190321
    privileged: true
    ports:
      #admin
      - 10021:2601
      #ospf
      - 10022:2604
      #ospf ipv6
      - 10024:2606
    networks:
      n101s1:
        ipv4_address: 192.168.1.12 # Conecta R1
      n101s2:
        ipv4_address: 192.168.2.12 # Conecta Web Server
      n101s4:
        ipv4_address: 192.168.4.12 # Conecta R3
  r3:
    build: .
    volumes:
      - ./volumes/quagga/r3/zebra.conf:/etc/quagga/zebra.conf:ro
      - ./volumes/quagga/r3/ospfd.conf:/etc/quagga/ospfd.conf:ro
      - ./volumes/quagga/r3/ospf6d.conf:/etc/quagga/ospf6d.conf:ro
      - ./volumes/supervisord.conf:/etc/supervisord.conf:ro
    image: ospf:20190321
    privileged: true
    ports:
      #admin
      - 10031:2601
      #ospf
      - 10032:2604
      #ospf ipv6
      - 10033:2606
    networks:
      n101s3:
        ipv4_address: 192.168.3.13 # Conecta H1
      n101s4:
        ipv4_address: 192.168.4.13 # Conecta R2
      n101s5:
        ipv4_address: 192.168.5.13 # Conecta R1
  r4:
    build: .
    volumes:
      - ./volumes/quagga/r4/zebra.conf:/etc/quagga/zebra.conf:ro
      - ./volumes/quagga/r4/ospfd.conf:/etc/quagga/ospfd.conf:ro
      - ./volumes/quagga/r4/ospf6d.conf:/etc/quagga/ospf6d.conf:ro
      - ./volumes/quagga/r4/bgpd.conf:/etc/quagga/bgpd.conf:ro
      - ./volumes/supervisord.conf:/etc/supervisord.conf:ro
    image: ospf:20190321
    privileged: true
    ports:
      #admin
      - 10041:2601
      #ospf
      - 10042:2604
      #ospf ipv6
      - 10043:2606
    networks:
      n102s6:
        ipv4_address: 192.168.6.14 # Conecta H2
      common1:
        ipv4_address: 192.168.8.14 # Conecta R1
      common2:
        ipv4_address: 192.168.9.14 # conecta R5
  r5:
    build: .
    volumes:
      - ./volumes/quagga/r5/zebra.conf:/etc/quagga/zebra.conf:ro
      - ./volumes/quagga/r5/ospfd.conf:/etc/quagga/ospfd.conf:ro
      - ./volumes/quagga/r5/ospf6d.conf:/etc/quagga/ospf6d.conf:ro
      - ./volumes/quagga/r5/bgpd.conf:/etc/quagga/bgpd.conf:ro
      - ./volumes/supervisord.conf:/etc/supervisord.conf:ro
    image: ospf:20190321
    privileged: true
    ports:
      #admin
      - 10051:2601
      #ospf
      - 10052:2604
      #ospf ipv6
      - 10053:2606
    networks:
      n103s7:
        ipv4_address: 192.168.7.15 # Conecta H3
      common2:
        ipv4_address: 192.168.9.15 # Conecta R4
      common3:
        ipv4_address: 192.168.10.15 # Conecta R1

# hosts
  h1:
    volumes: 
      - './volumes/hosts/h1_networks:/etc/network/interfaces:ro'
    image: alpine
    privileged: true 
    command:  ash -c "ip route del default && ip route add default via 192.168.3.13 && top"
    networks:
      n101s3:
        ipv4_address: 192.168.3.20
  h2:
    image: alpine
    privileged: true
    command: ash -c "ip route del default && ip route add default via 192.168.6.14 && top"
    networks:
      n102s6:
        ipv4_address: 192.168.6.20
  h3:
    image: alpine
    privileged: true
    command: ash -c "ip route del default && ip route add default via 192.168.7.15 && top"
    networks:
      n103s7:
        ipv4_address: 192.168.7.20

#services
  webserver:
    image: httpd:alpine
    volumes:
      - './volumes/static/html:/usr/local/apache2/htdocs:ro'
    privileged: true
    ports:
      - 10180:80
    networks:
      n101s2:
        ipv4_address: 192.168.2.20

networks:
  # redes de AS101
  n101s1:
    driver: "bridge"
    ipam:
        driver: default
        config:
         - subnet: 192.168.1.0/24
  n101s2:
    driver: "bridge"
    ipam:
        driver: default
        config:
         - subnet: 192.168.2.0/24
  n101s3:
    driver: "bridge"
    ipam:
        driver: default
        config:
         - subnet: 192.168.3.0/24
  n101s4:
    driver: "bridge"
    ipam:
        driver: default
        config:
         - subnet: 192.168.4.0/24
  n101s5:
    driver: "bridge"
    ipam:
        driver: default
        config:
         - subnet: 192.168.5.0/24
  # redes de AS102
  n102s6:
    driver: "bridge"
    ipam:
      driver: default
      config:
        - subnet: 192.168.6.0/24
  # redes de AS103
  n103s7:
    driver: "bridge"
    ipam:
      driver: default
      config:
        - subnet: 192.168.7.0/24

  # redes comunes
  common1:
    driver: "bridge"
    ipam:
      driver: default
      config:
        - subnet: 192.168.8.0/24
  common2:
    driver: "bridge"
    ipam:
      driver: default
      config:
        - subnet: 192.168.9.0/24
  common3:
    driver: "bridge"
    ipam:
      driver: default
      config:
        - subnet: 192.168.10.0/24
